name: Production Deployment

on:
  push:
    branches:
      - master

concurrency:
  group: master
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment: Production

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup SSH Key
        env:
          SERVER_PRIVATE_KEY: ${{ secrets.SERVER_PRIVATE_KEY }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_PORT: ${{ secrets.SERVER_PORT }}
          SERVER_USERNAME: ${{ secrets.SERVER_USERNAME }}
        run: |
          # Ensure required environment variables are set
          if [ -z "$SERVER_HOST" ] || [ -z "$SERVER_USERNAME" ]; then
            echo "❌ Missing SSH credentials. Ensure SERVER_HOST and SERVER_USERNAME are set."
            exit 1
          fi
          
          mkdir -p ~/.ssh/
          echo "$SERVER_PRIVATE_KEY" > ~/.ssh/github_deploy_key.ppk
          chmod 600 ~/.ssh/github_deploy_key.ppk
          
          # Validate the SSH key format
          if ! grep -q "PRIVATE KEY" ~/.ssh/github_deploy_key.ppk; then
            echo "❌ SSH key does not look valid!"
            exit 1
          fi
          
          # Add to known hosts (avoids interactive prompt)
          if ! ssh-keyscan -p "${SERVER_PORT:-22}" -H "$SERVER_HOST" >> ~/.ssh/known_hosts 2>/dev/null; then
            echo "❌ ssh-keyscan failed: host '$SERVER_HOST' could not be resolved or reached."
            exit 1
          fi

      - name: Test SSH Connection
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_PORT: ${{ secrets.SERVER_PORT }}
          SERVER_USERNAME: ${{ secrets.SERVER_USERNAME }}
        run: |
          ssh -p "${SERVER_PORT:-22}" -i ~/.ssh/github_deploy_key.ppk "$SERVER_USERNAME@$SERVER_HOST" "echo '✅ SSH Connected to Server'"

      - name: Run Deployment Commands
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_PORT: ${{ secrets.SERVER_PORT }}
          SERVER_USERNAME: ${{ secrets.SERVER_USERNAME }}
        run: |
          ssh -p "${SERVER_PORT:-22}" -i ~/.ssh/github_deploy_key.ppk "$SERVER_USERNAME@$SERVER_HOST" << 'EOF'
            sudo /root/homelab/deploy_homelab.sh
          EOF
