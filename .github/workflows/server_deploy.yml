name: Production Deployment

on:
  push:
    branches:
      - master

concurrency:
  group: master
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment: Production

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup SSH key and cloudflared
        env:
          SERVER_PRIVATE_KEY: ${{ secrets.SERVER_PRIVATE_KEY }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_PORT: ${{ secrets.SERVER_PORT }}
          SERVER_USERNAME: ${{ secrets.SERVER_USERNAME }}
          CF_ACCESS_CLIENT_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
          CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
        run: |
          set -e

          if [ -z "$SERVER_HOST" ] || [ -z "$SERVER_USERNAME" ]; then
            echo "âŒ Missing SSH credentials. Ensure SERVER_HOST and SERVER_USERNAME are set."
            exit 1
          fi

          echo "ðŸ”‘ Writing SSH key"
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # Store as an OpenSSH key file (NOT .ppk)
          echo "$SERVER_PRIVATE_KEY" > ~/.ssh/github_deploy_key
          chmod 600 ~/.ssh/github_deploy_key

          # Basic sanity check
          if ! grep -q "PRIVATE KEY" ~/.ssh/github_deploy_key; then
            echo "âŒ SSH key does not look like a private key!"
            exit 1
          fi

          echo "ðŸŒ Installing cloudflared"
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o /usr/local/bin/cloudflared
          chmod +x /usr/local/bin/cloudflared
          cloudflared --version || { echo "âŒ cloudflared failed to install"; exit 1; }
          
          echo "CF_ACCESS_CLIENT_ID=$CF_ACCESS_CLIENT_ID" >> $GITHUB_ENV
          echo "CF_ACCESS_CLIENT_SECRET=$CF_ACCESS_CLIENT_SECRET" >> $GITHUB_ENV

          echo "ðŸ“ Writing SSH config"
          cat > ~/.ssh/config <<EOF
          Host homelab
            HostName $SERVER_HOST
            User $SERVER_USERNAME
            IdentityFile ~/.ssh/github_deploy_key
            StrictHostKeyChecking no
            UserKnownHostsFile=/dev/null
          
            # Use cloudflared to reach SSH over the Cloudflare Tunnel
            ProxyCommand cloudflared access ssh --hostname $SERVER_HOST
          EOF

          chmod 600 ~/.ssh/config

      - name: Test SSH connection via Cloudflare Tunnel
        run: |
          echo "ðŸ”Ž Testing SSH connection to homelab via Cloudflare Tunnel..."
          ssh -v homelab "echo 'âœ… SSH connected via Cloudflare Tunnel on $(hostname)'"

      - name: Run deployment script
        run: |
          echo "ðŸš€ Kicking off deploy_homelab.sh in background..."
          ssh homelab "nohup /root/homelab/deploy_homelab.sh &"
          echo "âœ… Deployment started"
