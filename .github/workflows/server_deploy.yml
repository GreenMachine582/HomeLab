name: Production Deployment

on:
  push:
    branches:
      - master

concurrency:
  group: master
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment: Production

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup SSH key and cloudflared
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
        run: |
          set -e

          if [ -z "$SSH_HOST" ] || [ -z "$SSH_USERNAME" ]; then
            echo "âŒ Missing SSH credentials. Ensure SSH_HOST and SSH_USERNAME are set."
            exit 1
          fi

          echo "ðŸ”‘ Writing SSH key"
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # Store as an OpenSSH key file (NOT .ppk)
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/github_deploy_key
          chmod 600 ~/.ssh/github_deploy_key

          # Basic sanity check
          if ! grep -q "PRIVATE KEY" ~/.ssh/github_deploy_key; then
            echo "âŒ SSH key does not look like a private key!"
            exit 1
          fi

          echo "ðŸŒ Installing cloudflared"
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o /usr/local/bin/cloudflared
          chmod +x /usr/local/bin/cloudflared
          cloudflared --version || { echo "âŒ cloudflared failed to install"; exit 1; }

          echo "ðŸ“ Writing SSH config"
          cat > ~/.ssh/config <<EOF
          Host homelab
            HostName $SSH_HOST
            User $SSH_USERNAME
            IdentityFile ~/.ssh/github_deploy_key
            StrictHostKeyChecking no
            UserKnownHostsFile=/dev/null
          
            # Use cloudflared to reach SSH over the Cloudflare Tunnel
            ProxyCommand cloudflared access ssh \
              --hostname $SSH_HOST \
              --destination ssh://localhost:${SSH_PORT:-22} \
              --url 127.0.0.1:2222
          EOF

          chmod 600 ~/.ssh/config

      - name: Test SSH connection via Cloudflare Tunnel
        run: |
          echo "ðŸ”Ž Testing SSH connection to homelab via Cloudflare Tunnel..."
          ssh -v homelab "echo 'âœ… SSH connected via Cloudflare Tunnel on $(hostname)'"

      - name: Run deployment script
        run: |
          echo "ðŸš€ Running deploy_homelab.sh on server..."
          ssh homelab "sudo /root/homelab/deploy_homelab.sh"
          echo "âœ… Deployment completed successfully"
