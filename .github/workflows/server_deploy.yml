name: Production Deployment

on:
  push:
    branches:
      - master

concurrency:
  group: master
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment: Production

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Deploy over Cloudflare Tunnel (SSH)
        uses: and-fm/cloudflared-ssh-action@v3
        with:
          host: ${{ secrets.SSH_HOST }}            # ssh.green-tech-hub.com
          port: ${{ secrets.SSH_PORT }}            # usually 22
          username: ${{ secrets.SSH_USERNAME }}    # github-deploy
          private_key_filename: github_deploy_key  # filename used inside runner
          private_key_value: ${{ secrets.SSH_PRIVATE_KEY }}

          service_token_id: ${{ secrets.CF_ACCESS_CLIENT_ID }}
          service_token_secret: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}

          commands: |
            echo "✅ Connected via Cloudflare Tunnel as $(whoami)"
            sudo /root/homelab/deploy_homelab.sh
            echo "✅ Deployment completed successfully"
